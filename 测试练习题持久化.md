# 🧪 练习题持久化 - 测试指南

## 快速测试

### 测试1: 练习题持久化 ✅

```bash
1. 启动应用
   npm run dev

2. 访问学习中心
   http://localhost:3000/dashboard

3. 进入第一个关卡
   点击 "第01天 - Python魔法入门"

4. 完成第一个练习题
   - 编写代码: print("我开始学习Python魔法了！")
   - 点击"运行代码"
   - 看到 ✅ 代码执行成功

5. 刷新页面 (按 F5 或 Cmd+R)
   ✓ 练习题仍然显示为已完成（有 ✓ 标记）
   ✓ 完成进度显示 "1/X 完成"

6. 退出应用再重新打开
   ✓ 练习题状态依然保持
```

### 测试2: 成就解锁 🏆

```bash
1. 完成第一个练习题
   ✓ 应该解锁 "🎯 首杀" 成就

2. 访问成就页面
   http://localhost:3000/achievements
   ✓ 看到 "🎯 首杀" 已解锁
   ✓ "完成练习" 统计显示 1

3. 继续完成更多练习题
   - 完成10个 → 🏆 "📝 勤奋学生"
   - 完成50个 → 🏆 "📚 练习达人"

4. 完成第一个关卡的所有练习题
   ✓ 应该解锁 "🎓 第一步" 成就
   ✓ "完成关卡" 统计增加
```

### 测试3: 用户隔离 👥

```bash
1. 使用账号A登录
   - 完成练习题 1, 2, 3

2. 退出账号A

3. 使用账号B登录
   ✓ 看到全新的状态（没有已完成的练习题）
   
4. 账号B完成练习题 4, 5, 6

5. 退出，重新登录账号A
   ✓ 账号A仍然只完成了 1, 2, 3
   ✓ 账号B的进度不会影响账号A
```

### 测试4: Demo模式 🎮

```bash
1. 不登录，直接使用
   - 完成几个练习题

2. 刷新页面
   ✓ Demo用户的进度也会保存
   ✓ 使用 'demo-user' ID 保存

3. 登录真实账号
   ✓ 看到独立的进度（与demo用户不同）
```

## 数据库验证

### 查看练习题提交记录

```sql
-- 查看所有用户的练习题提交
SELECT 
  user_id,
  exercise_id,
  passed,
  score,
  submitted_at
FROM user_exercise_submissions
ORDER BY submitted_at DESC;

-- 查看特定用户的提交
SELECT 
  ues.user_id,
  e.title,
  ues.passed,
  ues.score,
  ues.submitted_at
FROM user_exercise_submissions ues
JOIN exercises e ON ues.exercise_id = e.id
WHERE ues.user_id = 'your-user-id'
ORDER BY ues.submitted_at DESC;

-- 统计用户完成的练习题数量
SELECT 
  user_id,
  COUNT(*) as total_submissions,
  SUM(CASE WHEN passed THEN 1 ELSE 0 END) as passed_count
FROM user_exercise_submissions
GROUP BY user_id;
```

### 查看用户成就

```sql
-- 查看已解锁的成就
SELECT 
  ua.user_id,
  a.title,
  a.category,
  a.rarity,
  a.points,
  ua.unlocked_at
FROM user_achievements ua
JOIN achievements a ON ua.achievement_id = a.id
WHERE ua.user_id = 'your-user-id'
ORDER BY ua.unlocked_at DESC;

-- 查看用户统计
SELECT * FROM user_stats WHERE user_id = 'your-user-id';
```

## 预期行为

### ✅ 正常情况

| 操作 | 预期结果 |
|------|----------|
| 完成练习题 | ✓ 保存到数据库 |
| 刷新页面 | ✓ 状态保持 |
| 退出重新登录 | ✓ 数据完整 |
| 第一个练习题 | ✓ 解锁"首杀"成就 |
| 完成10个练习题 | ✓ 解锁"勤奋学生"成就 |
| 完成第一个关卡 | ✓ 解锁"第一步"成就 |

### ❌ 异常情况（已修复）

| 问题 | 原因 | 修复状态 |
|------|------|----------|
| 刷新后数据丢失 | 没有保存到数据库 | ✅ 已修复 |
| 成就不触发 | 没有传递userId | ✅ 已修复 |
| 退出后清零 | 没有读取数据库 | ✅ 已修复 |

## 调试技巧

### 浏览器控制台

```javascript
// 打开控制台 (F12)，查看网络请求

// 完成练习题时应该看到:
POST /api/exercises/submit
POST /api/exercises/run

// 页面加载时应该看到:
GET /api/exercises/submit?userId=xxx&levelId=xxx
GET /api/levels/1
```

### 检查本地存储

```javascript
// 打开控制台，查看是否有错误
console.log('检查错误')

// 查看网络请求
// Network -> XHR/Fetch
```

### 服务器日志

```bash
# 查看 npm run dev 的输出
# 应该看到类似的日志:

"记录练习题完成"
"检查成就"
"保存练习题提交"
```

## 常见问题

### Q: 练习题状态还是丢失？

**A: 检查**:
1. 是否登录了账号？（或使用demo模式）
2. 浏览器控制台是否有错误？
3. 数据库连接是否正常？
4. 查看数据库是否有记录

### Q: 成就还是不触发？

**A: 检查**:
1. CodeEditor 是否传递了 userId？
2. 查看服务器日志是否有错误
3. 检查 user_stats 表是否有数据
4. 验证成就系统数据库是否初始化

### Q: 不同账号的数据混在一起？

**A**: 这不应该发生，检查：
1. 用户ID是否正确
2. 数据库查询是否正确过滤了 user_id
3. 查看数据库实际数据

## 性能检查

### 加载时间

```
页面加载 → 获取关卡数据 (< 200ms)
         ↓
      获取练习题 (< 200ms)
         ↓
      获取完成记录 (< 200ms)
         ↓
      渲染完成 ✅
```

### 提交时间

```
点击运行 → 执行代码 (1-2s, Piston API)
         ↓
      保存记录 (< 100ms)
         ↓
      检查成就 (< 100ms)
         ↓
      更新UI ✅
```

## 完成测试后

✅ 所有测试通过，表示修复成功！

现在你可以：
1. 🎮 安心学习，不怕数据丢失
2. 🏆 收集成就，追踪进度
3. 👥 切换账号，数据隔离
4. 📊 查看统计，了解自己的学习情况

---

**祝你学习愉快！有问题随时查看文档或提Issue！** 🚀

